<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.spring.mapper.StockMapper">
    <resultMap id="selectListRecommendStockByUserIdResultMap" type="StockVO" autoMapping="true">
        <id property="stockId" column="stockId"/>
        <collection property="recommendStockVOList" ofType="RecommendStockVO" autoMapping="true">
        </collection>
    </resultMap>

    <select id="selectListRecommendStockByUserId" parameterType="map"
            resultMap="selectListRecommendStockByUserIdResultMap">
        SELECT s.STOCK_ID AS stockId
        , s.SHORT_CODE AS shortCode
        , s.STOCK_NAME as stockName
        , rs.RECOMMEND_STOCK_ID AS recommendStockId
        , rs.USER_ID AS userId
        , rs.CONTENT AS content
        FROM RECOMMEND_STOCK rs
        JOIN STOCK s ON rs.STOCK_ID = s.STOCK_ID
        WHERE USER_ID = #{userId}
        <choose>
            <when test="date != null and date != ''">
                AND DATE_FORMAT(rs.CREATED_AT, '%Y-%m-%d') LIKE CONCAT('%', #{date}, '%');
            </when>
            <otherwise>
                AND DATE_FORMAT(rs.CREATED_AT, '%Y-%m-%d') = DATE_FORMAT(CURRENT_TIMESTAMP, '%Y-%m-%d')
            </otherwise>
        </choose>
    </select>
</mapper>
