<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.spring.mapper.StockMapper">
    <resultMap id="selectListRecommendStockByUserIdResultMap" type="StockVO" autoMapping="true">
        <id property="stockId" column="stock_id"/>
        <collection property="recommendStockVOList" ofType="RecommendStockVO" autoMapping="true">
        </collection>
    </resultMap>

    <select id="selectListRecommendStockByUserId" parameterType="map"
            resultMap="selectListRecommendStockByUserIdResultMap">
        SELECT rs.USER_ID AS userId
        , rs. RECOMMEND_STOCK_ID AS recommendStockId
        , rs.CONTENT AS content
        , s.STOCK_ID AS stockId
        , s.STOCK_NAME as stockName
        , s.SHORT_CODE AS shortCode
        FROM RECOMMEND_STOCK rs
        JOIN STOCK s ON rs.STOCK_ID = s.STOCK_ID
        WHERE USER_ID = #{userId}
        <choose>
            <when test="date != null and date != ''">
                AND DATE_FORMAT('YYYY-MM-DD', rs.CREATED_AT) LIKE CONCAT('%', #{date}, '%');
            </when>
            <otherwise>
                AND DATE_FORMAT('YYYY-MM-DD', rs.CREATED_AT) = DATE_FORMAT('YYYY-MM-DD', CURRENT_TIMESTAMP)
            </otherwise>
        </choose>
    </select>
    <select id="findByStockId" parameterType="Long" resultType="StockVO">
        SELECT *
        FROM STOCK
        WHERE STOCK_ID = #{stockId}
    </select>
    <insert id="insert" parameterType="StockVO">
        INSERT INTO STOCK
        (STANDARD_CODE, SUB_CATEGORY_ID, STOCK_NAME, SHORT_CODE, STOCK_EXCHANGE_MARKET, MARKET_CAPITALIZATION, STOCK_TRADE_STATUS)
        VALUES
        (#{standardCode}, #{subCategoryId}, #{stockName}, #{shortCode}, #{stockExchangeMarket}, #{marketCapitalization}, #{stockTradeStatus})
    </insert>
    <select id="findShortCodeByStockId" parameterType="Long" resultType="String">
        SELECT SHORT_CODE
        FROM STOCK
        WHERE STOCK_ID = #{stockId}
    </select>

    <select id="selectListPortfolioByUserId" parameterType="string" resultMap="selectListPortfolioByUserIdResultMap">
        SELECT s.STOCK_ID AS stockId
        , s.SHORT_CODE AS shortCode
        , s.STOCK_NAME AS stockName
        , s.STOCK_TRADE_STATUS AS stockTradeStatus
        , p.PORTFOLIO_ID AS portfolioId
        , p.USER_ID AS userId
        , p.PRICE AS price
        , p.QUANTITY AS quantity
        , p.ORDER_TYPE AS orderType
        FROM STOCK s
        JOIN PORTFOLIO p ON s.STOCK_ID = p.STOCK_ID
        AND s.SHORT_CODE = p.SHORT_CODE
        AND p.USER_ID = #{userId}
    </select>
</mapper>
